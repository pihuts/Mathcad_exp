# Phase 2.1: MathcadPy Migration - Research

**Researched:** January 25, 2026
**Domain:** Mathcad Prime COM API migration
**Confidence:** HIGH

## Summary

Research investigated migrating from custom COM implementation to the mature MathcadPy library (v0.5). The current worker.py uses direct win32com.client calls that require manual COM thread initialization, error handling, and low-level API management. MathcadPy provides a tested, maintained abstraction that handles these complexities automatically with a cleaner, Pythonic API.

**Key findings:**
- MathcadPy wraps the same "MathcadPrime.Application" COM ProgID with higher-level abstractions
- All current worker.py functionality has direct MathcadPy equivalents
- MathcadPy handles COM thread initialization internally (pythoncom.CoInitialize not needed)
- Exception handling is built-in via MathcadComError class
- Unit handling is more sophisticated with automatic preservation
- Matrix operations support both lists and numpy arrays
- PDF export only works with Mathcad Prime 5+, current code defaults to format 3

**Primary recommendation:** Replace worker.py's MathcadWorker with MathcadPy's Mathcad and Worksheet classes while maintaining the existing harness.py command protocol and JobRequest/JobResult interface. This preserves the current multiprocessing architecture while gaining stability.

## Standard Stack

The established libraries/tools for Mathcad Prime automation:

### Core
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| MathcadPy | 0.5 | Python wrapper for Mathcad Prime COM API | Mature, maintained abstraction with 40 GitHub stars, handles low-level COM complexities |
| pywin32 | Latest (via MathcadPy) | Windows COM client support | Required dependency of MathcadPy, handles win32com dispatch |

### Supporting
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| numpy | Optional | Matrix operations | When working with matrix inputs/outputs, MathcadPy handles both lists and arrays |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| MathcadPy | Direct win32com.client (current) | Current approach is fragile, requires manual error handling, no community support |
| MathcadPy | Mathcad API .NET SDK | Requires .NET runtime, no Python bindings, significantly more complex |

**Installation:**
```bash
# Already installed in environment, but for reference:
pip install MathcadPy
```

**Requirements:**
- Mathcad Prime 3+ (installed locally)
- Windows OS (required for COM)

## Architecture Patterns

### Recommended Project Structure
```
src/engine/
├── worker.py              # MathcadPy-based implementation (REPLACE)
├── harness.py             # Keep unchanged - protocol logic
├── protocol.py            # Keep unchanged - JobRequest/JobResult
├── manager.py             # Keep unchanged - EngineManager
└── batch_manager.py       # Keep unchanged - BatchManager
```

### Pattern 1: MathcadPy Application Lifecycle
**What:** Use Mathcad() class for application, Worksheet() class for individual worksheets
**When to use:** All Mathcad automation tasks
**Example:**
```python
# Source: https://github.com/MattWoodhead/MathcadPy/blob/master/MathcadPy/_application.py
from MathcadPy import Mathcad
from pathlib import Path

# Create Mathcad application instance (handles COM init internally)
mathcad_app = Mathcad(visible=True)

# Open worksheet (returns Worksheet object)
worksheet = mathcad_app.open(Path.cwd() / "file.mcdx")

# Work with worksheet...
inputs = worksheet.inputs()
outputs = worksheet.outputs()

# Close worksheet when done
worksheet.close()

# Quit application when done
mathcad_app.quit()
```

### Pattern 2: Input/Output Operations
**What:** Use MathcadPy's tuple return format (value, units, error_code)
**When to use:** All input/output operations
**Example:**
```python
# Source: https://github.com/MattWoodhead/MathcadPy/blob/master/MathcadPy/_application.py

# Get inputs list
input_names = worksheet.inputs()  # Returns: ["input1", "input2", ...]

# Set real input
error = worksheet.set_real_input("input1", 42.0, units="m", preserve_worksheet_units=True)
# Returns error code (0 = success)

# Set string input
error = worksheet.set_string_input("string_input", "hello")

# Set matrix input (list or numpy array)
matrix = [[1, 2], [3, 4]]
error = worksheet.set_matrix_input("matrix_input", matrix, units="s")

# Get output (returns tuple: value, units, error_code)
value, units, error_code = worksheet.get_real_output("output1")
if error_code != 0:
    raise Exception(f"Error getting output: {error_code}")

# Get matrix output
matrix, units, error_code = worksheet.get_matrix_output("matrix_output")
```

### Pattern 3: Calculation Control
**What:** Use pause/resume/calculate methods for performance
**When to use:** Setting multiple inputs before calculating
**Example:**
```python
# Source: https://github.com/MattWoodhead/MathcadPy/blob/master/MathcadPy/_application.py

# Pause calculation for faster bulk input setting
worksheet.pause_calculation()

# Set multiple inputs
worksheet.set_real_input("input1", 1.0)
worksheet.set_real_input("input2", 2.0)
worksheet.set_real_input("input3", 3.0)

# Resume and calculate
worksheet.resume_calculation()
worksheet.calculate()  # Alias for syncronize()
```

### Pattern 4: Saving Worksheets
**What:** Use save_as() with Path objects, automatic format detection
**When to use:** Saving worksheets in different formats
**Example:**
```python
# Source: https://github.com/MattWoodhead/MathcadPy/blob/master/examples.py
from pathlib import Path

# Save as Mathcad file
worksheet.save_as(Path.cwd() / "output.mcdx")

# Save as RTF
worksheet.save_as(Path.cwd() / "output.rtf")

# Save as XPS
worksheet.save_as(Path.cwd() / "output.xps")

# Save as PDF (only works with Mathcad Prime 5+)
if mathcad_app.version_major_int > 4:
    worksheet.save_as(Path.cwd() / "output.pdf")
```

### Anti-Patterns to Avoid
- **Manual COM initialization:** Don't call `pythoncom.CoInitialize()` - MathcadPy handles this internally
- **Direct win32com calls:** Don't bypass MathcadPy abstraction - defeats the purpose of migration
- **Ignoring error codes:** Always check error_code from get_*_output methods (return tuples)
- **Unit string guessing:** Use preserve_worksheet_units=True to maintain worksheet's units unless explicitly changing them

## Don't Hand-Roll

Problems that look simple but have existing solutions:

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| COM thread management | pythoncom.CoInitialize() per process | MathcadPy's internal handling | Handles edge cases, proper cleanup, already tested |
| Error wrapping | Custom exception classes | MathcadComError | Provides consistent error reporting, includes error codes |
| Unit handling | Manual unit string management | preserve_worksheet_units=True | Prevents unit mismatches, maintains worksheet intent |
| Matrix conversion | Manual 2D list handling | set_matrix_input() / get_matrix_output() | Handles COM matrix objects, numpy integration |
| Worksheet tracking | Manual dict of open worksheets | Mathcad.open_worksheets dict | Automatic tracking, name-based lookup |
| Version detection | Parsing GetVersion() string | mathcad_app.version_major_int | Already parsed, cached as integer |

**Key insight:** MathcadPy has already solved all the "simple" COM problems that the current worker.py manually implements. Rebuilding these would introduce bugs in code that's already tested by 40+ GitHub users.

## Common Pitfalls

### Pitfall 1: Ignoring Tuple Return Format
**What goes wrong:** Trying to use output as a single value instead of unpacking (value, units, error_code)
**Why it happens:** Current worker.py returns single values from get_output_value(), MathcadPy returns tuples
**How to avoid:** Always unpack the tuple and check error_code before using the value
**Warning signs:** TypeError when trying to do math on tuple

```python
# WRONG (current pattern)
value = worker.get_output_value("output1")  # Returns single value

# RIGHT (MathcadPy pattern)
value, units, error_code = worksheet.get_real_output("output1")
if error_code != 0:
    raise Exception(f"Error: {error_code}")
# Now safe to use value
```

### Pitfall 2: Not Handling COM Initialization in Multiprocess
**What goes wrong:** COM errors when MathcadWorker runs in separate process without pythoncom.CoInitialize()
**Why it happens:** Current worker.py manually calls pythoncom.CoInitialize() at line 12
**How to avoid:** Remove the manual CoInitialize() call - MathcadPy handles this automatically in its __init__
**Warning signs:** "CoInitialize has not been called" or "Invalid class string" errors in worker process

### Pitfall 3: PDF Export on Older Mathcad Versions
**What goes wrong:** ValueError when trying to save_as() with .pdf extension on Mathcad Prime 4 or earlier
**Why it happens:** PDF export only officially supported in Mathcad Prime 5+ (some late v5 builds had it, v6+ guaranteed)
**How to avoid:** Check version_major_int before attempting PDF save, fall back to RTF/XPS
**Warning signs:** "Mathcad Prime 8 or newer is required to export as PDF" (error message from code, but actual requirement is v5+)

```python
# From MathcadPy source (save_as method):
if new_filepath.suffix.lower() == ".pdf":
    if self._app_class.version_major_int > 4:
        self.ws_object.SaveAs(new_filepath)
    else:
        raise ValueError("Mathcad Prime 8 or newer is required to export as PDF")
```

### Pitfall 4: Unit Mismatches with preserve_worksheet_units
**What goes wrong:** AssertionError when trying to set input with different units than worksheet defines
**Why it happens:** preserve_worksheet_units=True (default) enforces unit consistency
**How to avoid:** Either set preserve_worksheet_units=False when you want to change units, or fetch current units first
**Warning signs:** "preserve_worksheet_units is True. The units argument does not equate to the units present in the Worksheet"

### Pitfall 5: Not Closing Worksheets/Quitting Application
**What goes wrong:** Mathcad instances left running, memory leaks, file locks
**Why it happens:** Current worker.py doesn't explicitly close/quit, relies on process termination
**How to avoid:** Explicitly call worksheet.close() and mathcad_app.quit() in shutdown sequence
**Warning signs:** Task Manager shows multiple MathcadPrime.exe processes after running tests

### Pitfall 6: String vs Real Input Confusion
**What goes wrong:** TypeError or COM error when using set_real_input() on string inputs or vice versa
**Why it happens:** Current worker.py has a single set_input() method that checks isinstance(value, str), MathcadPy has separate methods
**How to avoid:** Use set_real_input() for numeric values, set_string_input() for strings
**Warning signs:** "TypeError: must be real number, not str" or similar

## Code Examples

Verified patterns from official sources:

### Complete Worker Replacement
```python
# Source: https://github.com/MattWoodhead/MathcadPy/blob/master/examples.py
from MathcadPy import Mathcad
from pathlib import Path
from typing import List, Dict, Any, Optional

class MathcadWorker:
    """MathcadPy-based replacement for current worker.py"""

    def __init__(self):
        self.mc = None  # Mathcad() instance
        self.worksheet = None  # Worksheet() instance

    def connect(self) -> bool:
        """
        Connects to the Mathcad Prime Application.
        MathcadPy handles COM initialization automatically.
        """
        try:
            self.mc = Mathcad(visible=True)
            print(f"Connected to Mathcad version: {self.mc.version}")
            return True
        except Exception as e:
            raise Exception(f"Failed to connect to Mathcad: {str(e)}")

    def is_connected(self) -> bool:
        return self.mc is not None

    def open_file(self, path: str):
        if not self.mc:
            raise Exception("Mathcad not connected")

        abs_path = Path(path).resolve()
        if not abs_path.exists():
            raise FileNotFoundError(f"File not found: {abs_path}")

        try:
            self.worksheet = self.mc.open(abs_path)
            self.worksheet.activate()
        except Exception as e:
            raise Exception(f"Failed to open file {abs_path}: {str(e)}")

    def get_inputs(self) -> List[Dict[str, Any]]:
        if not self.worksheet:
            raise Exception("No worksheet open")

        try:
            input_names = self.worksheet.inputs()
            return [{"alias": name, "name": name, "units": ""} for name in input_names]
        except Exception as e:
            raise Exception(f"Failed to retrieve inputs: {str(e)}")

    def get_outputs(self) -> List[Dict[str, Any]]:
        if not self.worksheet:
            raise Exception("No worksheet open")

        try:
            output_names = self.worksheet.outputs()
            return [{"alias": name, "name": name, "units": ""} for name in output_names]
        except Exception as e:
            raise Exception(f"Failed to retrieve outputs: {str(e)}")

    def set_input(self, alias: str, value: Any):
        if not self.worksheet:
            raise Exception("No worksheet open")

        try:
            if isinstance(value, str):
                error = self.worksheet.set_string_input(alias, value)
                if error != 0:
                    raise Exception(f"set_string_input returned error code {error}")
            else:
                # Default to Real with empty units, preserve worksheet units
                error = self.worksheet.set_real_input(
                    alias, float(value), units="", preserve_worksheet_units=True
                )
                if error != 0:
                    raise Exception(f"set_real_input returned error code {error}")
        except Exception as e:
            raise Exception(f"Failed to set input {alias}: {str(e)}")

    def synchronize(self):
        if not self.worksheet:
            raise Exception("No worksheet open")

        try:
            self.worksheet.calculate()  # Alias for syncronize()
        except Exception as e:
            raise Exception(f"Failed to synchronize worksheet: {str(e)}")

    def get_output_value(self, alias: str) -> Any:
        if not self.worksheet:
            raise Exception("No worksheet open")

        try:
            value, units, error_code = self.worksheet.get_real_output(alias)
            if error_code != 0:
                raise Exception(f"Error getting output {alias}: ErrorCode {error_code}")
            return value
        except Exception as e:
            raise Exception(f"Failed to get output {alias}: {str(e)}")

    def save_as(self, path: str, format_enum: Optional[int] = None):
        """
        Saves the current worksheet in the specified format.
        MathcadPy handles format detection from file extension.
        format_enum is ignored (kept for backward compatibility).
        """
        if not self.worksheet:
            raise Exception("No worksheet open")

        abs_path = Path(path)

        # Check PDF export support
        if abs_path.suffix.lower() == ".pdf":
            if self.mc.version_major_int <= 4:
                raise ValueError(
                    f"PDF export requires Mathcad Prime 5+, current version: {self.mc.version}"
                )

        try:
            self.worksheet.save_as(abs_path)
        except Exception as e:
            raise Exception(f"Failed to save to {abs_path}: {str(e)}")

    def close(self):
        """Clean shutdown of worksheet and application"""
        if self.worksheet:
            try:
                self.worksheet.close()
            except:
                pass
            self.worksheet = None

        if self.mc:
            try:
                self.mc.quit(save_option="Discard")
            except:
                pass
            self.mc = None
```

### Bulk Input Optimization
```python
# Source: https://github.com/MattWoodhead/MathcadPy/blob/master/MathcadPy/_application.py
# Optimized for setting multiple inputs before calculating

def set_inputs_bulk(self, inputs: Dict[str, Any]):
    """Set multiple inputs efficiently by pausing calculation"""
    if not self.worksheet:
        raise Exception("No worksheet open")

    try:
        # Pause calculation for faster bulk input setting
        self.worksheet.pause_calculation()

        # Set all inputs
        for alias, value in inputs.items():
            if isinstance(value, str):
                self.worksheet.set_string_input(alias, value)
            else:
                self.worksheet.set_real_input(alias, float(value))

        # Resume and calculate once
        self.worksheet.resume_calculation()
        self.worksheet.calculate()

    except Exception as e:
        # Ensure calculation is resumed even if error occurs
        try:
            self.worksheet.resume_calculation()
        except:
            pass
        raise Exception(f"Failed to set bulk inputs: {str(e)}")
```

### Matrix Operations
```python
# Source: https://github.com/MattWoodhead/MathcadPy/blob/master/examples.py
import numpy as np  # Optional

def handle_matrix_input(self, alias: str, matrix_data):
    """Handle matrix input - works with both lists and numpy arrays"""

    # Convert list to numpy array if numpy is available
    if isinstance(matrix_data, list):
        try:
            import numpy as np
            matrix_data = np.array(matrix_data)
        except ImportError:
            # Fall back to list format
            pass

    try:
        error = self.worksheet.set_matrix_input(
            alias, matrix_data, units="", preserve_worksheet_units=True
        )
        if error != 0:
            raise Exception(f"set_matrix_input returned error code {error}")
    except Exception as e:
        raise Exception(f"Failed to set matrix input {alias}: {str(e)}")

def get_matrix_output(self, alias: str):
    """Get matrix output - returns list of lists"""
    try:
        matrix, units, error_code = self.worksheet.get_matrix_output(alias)
        if error_code != 0:
            raise Exception(f"Error getting matrix output {alias}: ErrorCode {error_code}")
        return matrix  # Returns [[r1c1, r1c2], [r2c1, r2c2], ...]
    except Exception as e:
        raise Exception(f"Failed to get matrix output {alias}: {str(e)}")
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Direct win32com.client.Dispatch() | MathcadPy wrapper library | Feb 2025 (MathcadPy v0.5) | Community-tested abstraction, better error handling |
| Manual pythoncom.CoInitialize() | Handled internally by MathcadPy | v0.1+ | Eliminates COM threading bugs in multiprocessing |
| Manual error code checking | MathcadComError exceptions with error codes | v0.1+ | More Pythonic error handling, consistent API |
| Single set_input() method | Separate set_real_input() / set_string_input() / set_matrix_input() | v0.1+ | Type-safe operations, clearer intent |
| save_as() with format enum | save_as() with Path object, automatic format detection | v0.1+ | Safer, less error-prone |

**Deprecated/outdated:**
- Manual COM initialization: pythoncom.CoInitialize() is not needed with MathcadPy
- Error code checking on SetRealValue: MathcadPy methods return error codes but also raises MathcadComError on COM errors
- discover_constants() pattern: MathcadPy handles constants internally

## Open Questions

Things that couldn't be fully resolved:

1. **Current save_as() format_enum parameter behavior**
   - What we know: Current code uses format enum 3 for PDF by default, searches for PDF in constants
   - What's unclear: What the exact mapping of format enum values to file formats is in the COM API
   - Recommendation: Let MathcadPy handle format detection via file extension (it already does this correctly for .mcdx, .pdf, .rtf, .xps)

2. **Worksheet state management in harness**
   - What we know: Current worker.py keeps self.worksheet as state between jobs
   - What's unclear: Should we explicitly close/reopen worksheets between jobs to prevent state leakage?
   - Recommendation: Keep current stateful approach (same worksheet used for multiple jobs) but add explicit close() method for cleanup

3. **Batch processing with MathcadPy**
   - What we know: MathcadPy supports pause_calculation() / resume_calculation() for bulk operations
   - What's unclear: Whether current batch_manager workflow benefits from this optimization
   - Recommendation: Evaluate performance impact, consider adding pause/resume for jobs with many inputs

## Sources

### Primary (HIGH confidence)
- MathcadPy source code (_application.py) - Complete API implementation
  - URL: https://raw.githubusercontent.com/MattWoodhead/MathcadPy/master/MathcadPy/_application.py
  - Verified: January 25, 2026
- MathcadPy examples.py - Working code examples
  - URL: https://raw.githubusercontent.com/MattWoodhead/MathcadPy/master/examples.py
  - Verified: January 25, 2026
- MathcadPy Wiki - Usage documentation
  - URL: https://github.com/MattWoodhead/MathcadPy/wiki/3.-Interacting-with-Mathcad-using-Python
  - Verified: January 25, 2026

### Secondary (MEDIUM confidence)
- GitHub Issues - Known problems and edge cases
  - URL: https://github.com/MattWoodhead/MathcadPy/issues
  - Verified: January 25, 2026
  - Issues examined: PDF export requirements, matrix input handling, unit preservation

### Tertiary (LOW confidence)
- None - All findings verified against primary sources

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - Directly from GitHub repository, verified installed version
- Architecture: HIGH - MathcadPy source code provides complete API reference
- Pitfalls: HIGH - Based on differences between current worker.py and MathcadPy implementation

**Research date:** January 25, 2026
**Valid until:** February 24, 2026 (30 days - library is stable, version 0.5 from Feb 2025)
