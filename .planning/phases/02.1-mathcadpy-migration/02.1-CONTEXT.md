# Phase 2.1: MathcadPy Migration - Context

**Gathered:** 2026-01-25
**Status:** Ready for planning

## Phase Boundary

Replace custom COM implementation with mature MathcadPy library for reliable Mathcad Prime communication. This is a technical refactoring phase - preserving all existing functionality while swapping to a stable library. No user-facing changes; migration is internal to `worker.py`.

## Implementation Decisions

### Error Handling Strategy
- **Use MathcadPy's built-in MathcadComError exceptions** — Adopt standard library exceptions instead of custom patterns
- **Expose error codes to harness** — Claude's discretion: error codes exposed for batch manager's retry logic to distinguish transient vs fatal errors
- **Adapt batch error logging to MathcadPy format** — Update logging to use MathcadPy error code format
- **Smarter recovery using error codes** — Use MathcadPy error codes to intelligently decide retry vs abort (not just "restart on failure")

### Interface Compatibility
- **Keep exact same worker interface** — Preserve identical `MathcadWorker` interface to hide MathcadPy changes internally; no harness changes needed
- **Unwrap tuples in worker** — Claude's discretion: MathcadPy returns `(value, units, error_code)` tuples but harness expects simple values; unwrap in worker before returning
- **Add optional parameters to input methods** — Add `units` and `preserve_worksheet_units` options from MathcadPy to `set_input()`
- **Use file extension detection for save_as** — Drop current `format_enum` parameter; rely on MathcadPy's automatic format detection from file extension (.pdf, .mcdx, etc.)

### Performance Optimization
- **Keep current per-input calculation approach** — Do NOT use `pause_calculation()` / `resume_calculation()` optimization; user experience: pausing causes errors
- **Current behavior maintained** — Mathcad auto-calculates; app just needs to set input values; no manual recalculate calls needed

### State Management
- **Keep stateful approach** — Maintain current worksheet-open approach (don't close/reopen between jobs)
- **Add save_as_template method** — Save base template before batch modifications for state safety
- **Close after each batch job** — Claude's discretion: call close after each job to prevent state leakage; re-open for next job if needed

## Specific Ideas

No specific requirements — follow MathcadPy standard patterns and preserve current behavior.

## Deferred Ideas

- **User-controlled sequence of inputs/outputs per batch row** — User wants to arrange operation order (input A → output A → input B → output B) per batch iteration. This is a new capability, belongs in a future phase (Phase 2.2 or similar), not part of COM migration scope.

---

*Phase: 02.1-mathcadpy-migration*
*Context gathered: 2026-01-25*
