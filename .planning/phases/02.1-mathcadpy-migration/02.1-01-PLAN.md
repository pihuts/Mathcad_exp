---
phase: 02.1-mathcadpy-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/engine/worker.py]
autonomous: true
user_setup: []

must_haves:
  truths:
    - "MathcadPy-based worker successfully opens .mcdx files"
    - "Input/output alias enumeration works with MathcadPy"
    - "Setting input values and reading outputs works with MathcadPy"
    - "Batch processing completes successfully with new worker"
    - "Worker interface unchanged (harness.py requires no modifications)"
  artifacts:
    - path: "src/engine/worker.py"
      provides: "MathcadPy-based MathcadWorker class"
      min_lines: 120
    - path: "src/engine/harness.py"
      provides: "Unchanged command protocol handler"
      modifications: 0
  key_links:
    - from: "src/engine/worker.py"
      to: "MathcadPy library"
      via: "from MathcadPy import Mathcad"
      pattern: "from MathcadPy import"
    - from: "src/engine/worker.py"
      to: "src/engine/harness.py"
      via: "Same MathcadWorker interface preserved"
      pattern: "class MathcadWorker"
    - from: "src/engine/worker.py"
      to: "Mathcad Prime COM"
      via: "MathcadPy abstraction layer"
      pattern: "Mathcad\\(\\)"
---

<objective>
Replace custom COM implementation in worker.py with mature MathcadPy library while preserving exact same interface and all existing functionality.

Purpose: Current COM implementation is fragile with manual error handling and requires constant debugging. MathcadPy provides a tested, maintained abstraction that handles COM complexities automatically with a cleaner, Pythonic API.

Output: Refactored worker.py using MathcadPy that maintains identical MathcadWorker interface, requiring no changes to harness.py or batch processing logic.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.1-mathcadpy-migration/02.1-CONTEXT.md
@.planning/phases/02.1-mathcadpy-migration/02.1-RESEARCH.md
@src/engine/worker.py
@src/engine/harness.py
@src/engine/protocol.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace worker.py with MathcadPy implementation</name>
  <files>src/engine/worker.py</files>
  <action>
    Replace the entire worker.py COM implementation with MathcadPy library while preserving exact same MathcadWorker interface:

    1. Import MathcadPy (not win32com.client):
       ```python
       from MathcadPy import Mathcad
       from pathlib import Path
       # Remove: import pythoncom, win32com.client
       ```

    2. Remove manual COM initialization in __init__:
       - Delete: `pythoncom.CoInitialize()` (MathcadPy handles this internally)
       - Remove: `self.constants = {}` and `discover_constants()` method (MathcadPy handles constants)

    3. Replace connect() method:
       ```python
       def connect(self) -> bool:
           try:
               self.mc = Mathcad(visible=True)
               print(f"Connected to Mathcad version: {self.mc.version}")
               return True
           except Exception as e:
               raise Exception(f"Failed to connect to Mathcad: {str(e)}")
       ```

    4. Replace get_inputs() method:
       ```python
       def get_inputs(self) -> List[Dict[str, Any]]:
           if not self.worksheet:
               raise Exception("No worksheet open")
           try:
               input_names = self.worksheet.inputs()
               return [{"alias": name, "name": name, "units": ""} for name in input_names]
           except Exception as e:
               raise Exception(f"Failed to retrieve inputs: {str(e)}")
       ```

    5. Replace get_outputs() method:
       ```python
       def get_outputs(self) -> List[Dict[str, Any]]:
           if not self.worksheet:
               raise Exception("No worksheet open")
           try:
               output_names = self.worksheet.outputs()
               return [{"alias": name, "name": name, "units": ""} for name in output_names]
           except Exception as e:
               raise Exception(f"Failed to retrieve outputs: {str(e)}")
       ```

    6. Replace set_input() method with MathcadPy's separate methods and optional parameters:
       ```python
       def set_input(self, alias: str, value: Any):
           if not self.worksheet:
               raise Exception("No worksheet open")
           try:
               if isinstance(value, str):
                   error = self.worksheet.set_string_input(alias, value)
                   if error != 0:
                       raise Exception(f"set_string_input returned error code {error}")
               else:
                   # Use preserve_worksheet_units=True as default
                   error = self.worksheet.set_real_input(
                       alias, float(value), units="", preserve_worksheet_units=True
                   )
                   if error != 0:
                       raise Exception(f"set_real_input returned error code {error}")
           except Exception as e:
               raise Exception(f"Failed to set input {alias}: {str(e)}")
       ```

    7. Replace synchronize() method:
       ```python
       def synchronize(self):
           if not self.worksheet:
               raise Exception("No worksheet open")
           try:
               self.worksheet.calculate()  # Alias for synchronize()
           except Exception as e:
               raise Exception(f"Failed to synchronize worksheet: {str(e)}")
       ```

    8. Replace get_output_value() method with tuple unwrapping:
       ```python
       def get_output_value(self, alias: str) -> Any:
           if not self.worksheet:
               raise Exception("No worksheet open")
           try:
               value, units, error_code = self.worksheet.get_real_output(alias)
               if error_code != 0:
                   raise Exception(f"Error getting output {alias}: ErrorCode {error_code}")
               return value  # Unwrap tuple, return only value
           except Exception as e:
               raise Exception(f"Failed to get output {alias}: {str(e)}")
       ```

    9. Replace save_as() method using file extension detection (drop format_enum):
       ```python
       def save_as(self, path: str, format_enum: Optional[int] = None):
           """
           Saves the current worksheet in the specified format.
           MathcadPy handles format detection from file extension.
           format_enum parameter ignored (kept for backward compatibility).
           """
           if not self.worksheet:
               raise Exception("No worksheet open")

           abs_path = Path(path)

           # Check PDF export support (only works with Mathcad Prime 5+)
           if abs_path.suffix.lower() == ".pdf":
               if self.mc.version_major_int <= 4:
                   raise ValueError(
                       f"PDF export requires Mathcad Prime 5+, current version: {self.mc.version}"
                   )

           try:
               self.worksheet.save_as(abs_path)  # MathcadPy auto-detects format from extension
           except Exception as e:
               raise Exception(f"Failed to save to {abs_path}: {str(e)}")
       ```

    10. Remove discover_constants() method entirely (not needed with MathcadPy).

    CRITICAL: Keep exact same method signatures and return types. Harness.py must not require any changes.

    Testing approach: After replacement, verify by examining worker.py imports (should be from MathcadPy, not win32com) and confirming all method names match original interface.
  </action>
  <verify>
    Check that worker.py imports MathcadPy (not win32com) and all method signatures match:
    ```bash
    grep "import" src/engine/worker.py | head -5
    grep "def " src/engine/worker.py | grep -v "__"
    ```
    Expected: `from MathcadPy import Mathcad` and all method names unchanged.
  </verify>
  <done>
    worker.py completely replaced with MathcadPy implementation, all method signatures preserved (connect, open_file, get_inputs, get_outputs, set_input, synchronize, get_output_value, save_as), format_enum parameter accepted but ignored in save_as.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify MathcadPy worker functionality and batch processing</name>
  <files>src/engine/worker.py, src/engine/harness.py</files>
  <action>
    Verify that the new MathcadPy-based worker works correctly by testing all methods and confirming batch processing workflow:

    1. Start the FastAPI backend to test worker through harness:
       ```bash
       cd backend && python -m uvicorn main:app --reload
       ```
       (or use existing startup command)

    2. Test worker method connectivity (no actual Mathcad file needed, just test that worker can be imported):
       - Import MathcadWorker: `from engine.worker import MathcadWorker`
       - Verify no ImportError or COM errors (MathcadPy handles COM internally)
       - Confirm class has all expected methods: `dir(MathcadWorker)`

    3. Verify harness.py still works (no changes needed):
       - Harness imports MathcadWorker successfully
       - All job commands still map to same worker methods:
         * "connect" → worker.connect()
         * "save_as" → worker.save_as(path, format_enum) [format_enum ignored]
         * "load_file" → worker.open_file(path)
         * "get_metadata" → worker.get_inputs(), worker.get_outputs()
         * "calculate_job" → worker.set_input(), worker.synchronize(), worker.get_output_value()

    4. Confirm batch_manager.py workflow still works:
       - BatchManager submits jobs via EngineManager.submit_job()
       - EngineManager routes to harness command protocol
       - Harness calls worker methods (now using MathcadPy)
       - Verify no changes needed in batch_manager.py or manager.py

    5. Verify error handling:
       - MathcadPy's MathcadComError exceptions are caught and wrapped
       - Error codes from get_output_value are checked before unwrapping
       - Error messages propagate correctly through harness → batch manager → frontend

    Testing focus: Confirm that harness.py, batch_manager.py, and manager.py require ZERO changes. The worker interface is identical, so existing code should work without modification.

    If real Mathcad testing is not possible during execution, verify by:
    - Checking imports (MathcadPy imported successfully)
    - Confirming method signatures match original
    - Tracing through code to ensure data flow is unchanged
    - Verifying batch_manager still submits jobs correctly
  </action>
  <verify>
    1. Verify worker imports MathcadPy:
       ```bash
       grep "from MathcadPy" src/engine/worker.py
       ```
    2. Verify harness.py unchanged:
       ```bash
       git diff src/engine/harness.py
       ```
       Expected: No changes (empty diff).
    3. Verify batch_manager.py unchanged:
       ```bash
       git diff src/engine/batch_manager.py
       ```
       Expected: No changes (empty diff).
  </verify>
  <done>
    MathcadPy-based worker imports successfully, all worker method signatures match original interface, harness.py and batch_manager.py require zero changes (verified by git diff), code tracing confirms batch workflow still functional (connect → open_file → set_input → synchronize → get_output_value → save_as).
  </done>
</task>

</tasks>

<verification>
After plan completion, verify:
1. Worker imports MathcadPy library (not win32com.client)
2. All MathcadWorker methods have exact same signatures as original
3. Harness.py has no modifications required
4. BatchManager has no modifications required
5. Batch workflow still functional through command protocol
6. Error handling works with MathcadPy exceptions
</verification>

<success_criteria>
- worker.py fully migrated to MathcadPy library
- Worker interface unchanged (harness.py works without modifications)
- All method signatures preserved (connect, open_file, get_inputs, get_outputs, set_input, synchronize, get_output_value, save_as)
- save_as uses file extension detection (format_enum parameter accepted but ignored)
- MathcadPy tuples unwrapped before returning values
- Batch processing workflow still functional through command protocol
- Zero changes required in harness.py, batch_manager.py, or manager.py
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-mathcadpy-migration/02.1-01-SUMMARY.md`
</output>
