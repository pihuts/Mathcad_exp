---
phase: 03.3-string-inputs
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/components/InputModal.tsx
  - frontend/src/App.tsx
autonomous: true

must_haves:
  truths:
    - "User can toggle between Number and String input type in the InputModal"
    - "String type shows Single Value tab (TextInput) and CSV tab, hides Range tab"
    - "Number type shows Range tab and CSV tab (existing behavior unchanged)"
    - "Units selector is hidden when input type is String"
    - "String values pass through the batch pipeline as strings (not coerced to numbers)"
    - "String values pass through the workflow pipeline as strings"
  artifacts:
    - path: "frontend/src/components/InputModal.tsx"
      provides: "Type selector (SegmentedControl), conditional tabs, string value handling"
      contains: "SegmentedControl"
    - path: "frontend/src/App.tsx"
      provides: "String-aware batch input construction and workflow input handling"
      contains: "inputType"
  key_links:
    - from: "frontend/src/components/InputModal.tsx"
      to: "frontend/src/App.tsx"
      via: "onSave callback returns InputConfig with string values"
      pattern: "onSave.*alias.*value"
    - from: "frontend/src/App.tsx"
      to: "src/engine/worker.py"
      via: "batch/workflow API sends string values that reach worker.set_input()"
      pattern: "isinstance.*str.*set_string_input"
---

<objective>
Add string input type support to the InputModal and ensure string values flow correctly through the batch and workflow pipelines.

Purpose: Engineers need to provide string-type inputs (material names, labels, file references) in addition to numeric inputs. MathcadPy already supports `set_string_input()`, and worker.py already routes strings correctly via `isinstance(value, str)`. The missing piece is the UI and frontend pipeline.

Output: Updated InputModal.tsx with Number/String type selector and conditional UI. Updated App.tsx with string-aware batch and workflow input handling.
</objective>

<execution_context>
@C:\Users\peter\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\peter\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.3-string-inputs/03.3-RESEARCH.md

# Source files to modify
@frontend/src/components/InputModal.tsx
@frontend/src/App.tsx

# Reference files (read-only, for understanding the pipeline)
@frontend/src/services/api.ts
@src/engine/worker.py
@src/engine/protocol.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add type selector and string input UI to InputModal</name>
  <files>frontend/src/components/InputModal.tsx</files>
  <action>
Modify InputModal.tsx to support both Number and String input types:

1. **Add SegmentedControl import** from `@mantine/core` (also add `TextInput` import). The existing imports already include Modal, NumberInput, Button, Stack, Group, Tabs, FileInput, Text, Select.

2. **Add inputType state**: `const [inputType, setInputType] = useState<'number' | 'string'>('number')`

3. **Add string value state**: `const [stringValue, setStringValue] = useState<string>('')`

4. **Add useEffect to reset activeTab when inputType changes**:
   - When inputType changes to 'string', set activeTab to 'single'
   - When inputType changes to 'number', set activeTab to 'range'
   - This prevents the user from being on a tab that doesn't exist for the current type

5. **Add SegmentedControl at the top of the modal content** (before the Tabs component):
   ```
   <SegmentedControl
     value={inputType}
     onChange={(val) => setInputType(val as 'number' | 'string')}
     data={[
       { label: 'Number', value: 'number' },
       { label: 'String', value: 'string' }
     ]}
     fullWidth
   />
   ```

6. **Make tabs conditional on inputType**:
   - When inputType === 'number': Show "Range" tab and "CSV File" tab (existing behavior)
   - When inputType === 'string': Show "Single Value" tab and "CSV File" tab
   - The Range Tabs.Panel should only render when inputType === 'number'
   - Add a new "Single Value" Tabs.Panel that only renders when inputType === 'string':
     ```
     <Tabs.Panel value="single" pt="md">
       <Stack>
         <TextInput
           label="String Value"
           placeholder="Enter text value (e.g., material name, label)"
           value={stringValue}
           onChange={(e) => setStringValue(e.currentTarget.value)}
         />
         <Text size="xs" c="dimmed">
           This value will be passed as-is to MathcadPy's set_string_input
         </Text>
       </Stack>
     </Tabs.Panel>
     ```

7. **Conditionally show Units selector**: Wrap the existing `<Select label="Units" ...>` in `{inputType === 'number' && ( ... )}` so it only shows for numeric inputs. Strings don't have units.

8. **Update handleSave to handle string type**:
   - For inputType === 'number': Keep existing logic (range generates numbers array, CSV maps to Number())
   - For inputType === 'string':
     - If activeTab === 'single': `value = [stringValue.trim()]` (wrap in array for consistency with batch pipeline)
     - If activeTab === 'csv': `value = csvData.map(row => String(row[selectedHeader]).trim())` (keep as strings, do NOT convert to Number)
   - Add validation: if string type and value contains empty strings after trim, return early (don't save)
   - Set units to undefined for string type: `units: inputType === 'number' ? (selectedUnits || undefined) : undefined`

CRITICAL - What to avoid and why:
- Do NOT call `Number()` on string-type CSV values. The whole point is type preservation.
- Do NOT add `inputType` field to the InputConfig interface in api.ts. Worker.py already uses `isinstance(value, str)` for detection. Adding a type field would require changes across the entire pipeline (protocol.py, harness.py, batch_manager.py) for zero benefit. Keep it simple - YAGNI.
- Do NOT change the onSave callback signature. It already returns InputConfig `{alias, value, units}`. String values are naturally preserved because JavaScript won't coerce them.
  </action>
  <verify>
Run `cd D:\Mathcad_exp\frontend && npx tsc --noEmit` to verify TypeScript compiles without errors.
Visually inspect InputModal.tsx to confirm:
1. SegmentedControl is imported and rendered
2. TextInput is imported and rendered in 'single' tab
3. Units selector is wrapped in inputType === 'number' conditional
4. handleSave has separate paths for 'number' and 'string' types
5. String CSV values use String() not Number()
  </verify>
  <done>
InputModal renders a Number/String type toggle. Selecting "String" shows a Single Value tab with TextInput and a CSV tab. Range tab and Units selector are hidden for strings. handleSave preserves string types through to onSave callback.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update App.tsx batch and workflow pipelines for string preservation</name>
  <files>frontend/src/App.tsx</files>
  <action>
Update App.tsx to correctly handle string values from InputModal through the batch and workflow pipelines:

1. **Update aliasConfigs state to track input types**: Add a new state to track which aliases are string vs number type:
   `const [aliasTypes, setAliasTypes] = useState<Record<string, 'number' | 'string'>>({})`

   This is needed because when building batch inputs in handleRun, we need to know whether values are strings (skip units, keep as string) or numbers (apply units, convert to number).

2. **Update handleSaveAliasConfig** to also store the input type:
   - Detect if value array contains strings: `const isString = Array.isArray(values) ? typeof values[0] === 'string' : typeof values === 'string'`
   - Store the type: `setAliasTypes(prev => ({ ...prev, [alias]: isString ? 'string' : 'number' }))`
   - Keep existing aliasConfigs and aliasUnits logic unchanged.

3. **Update handleRun batch input construction**: The current code in handleRun iterates over cartesian combinations and wraps values with units. For string-type aliases, we must NOT wrap with units and must ensure the value stays as a string.

   In the `for (const [key, value] of Object.entries(combo))` loop:
   ```typescript
   if (aliasTypes[key] === 'string') {
     // String values: pass directly, no units wrapper
     inputWithUnits[key] = value;  // Already a string
   } else {
     // Existing numeric logic
     const units = aliasUnits[key];
     if (units) {
       inputWithUnits[key] = { value, units };
     } else {
       inputWithUnits[key] = value;
     }
   }
   ```

4. **Update handleSaveWorkflowInputs** to preserve string types for workflow:
   The existing logic extracts `values` and `units` from the InputConfig. For strings:
   - The value will already be a string (from InputModal)
   - Units will be undefined (from InputModal)
   - No special handling needed since InputConfig.value is typed as `any`
   - However, verify that `Array.isArray(values) ? values[0] : values` correctly extracts the string value (it does, since string single values are wrapped in `[stringValue]` array by InputModal)

5. **Verify the Configuration badge display**: In the aliases table, `aliasConfigs[a.alias].length` shows "N values". For a single string value, this will show "1 values". This is acceptable for Phase 3.3 - the badge communicates that configuration exists.

CRITICAL - What to avoid and why:
- Do NOT modify api.ts InputConfig interface. String values are naturally `any` type.
- Do NOT modify batch_manager.py or protocol.py. The backend is already type-agnostic. InputConfig.value is `Any`, and worker.py uses isinstance() for routing.
- Do NOT add Number() conversion anywhere in the string path. The entire point is type preservation from UI to MathcadPy.
- Do NOT modify the batch API request format. batch_manager.py already handles both `{value, units}` dicts and plain values, and worker.py set_input already uses isinstance(value, str).
  </action>
  <verify>
Run `cd D:\Mathcad_exp\frontend && npx tsc --noEmit` to verify TypeScript compiles without errors.
Visually inspect App.tsx to confirm:
1. aliasTypes state exists
2. handleSaveAliasConfig stores type
3. handleRun skips units wrapper for string aliases
4. No Number() coercion in string paths
  </verify>
  <done>
App.tsx correctly preserves string values through the batch pipeline (no units wrapper, no number coercion) and workflow pipeline (string InputConfig values pass through unchanged). TypeScript compiles without errors.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `cd D:\Mathcad_exp\frontend && npx tsc --noEmit` passes
2. Frontend builds: `cd D:\Mathcad_exp\frontend && npm run build` completes without errors
3. Code inspection confirms:
   - InputModal has SegmentedControl with Number/String toggle
   - String type hides Range tab and Units selector
   - String type shows Single Value tab with TextInput
   - handleSave preserves string types (no Number() conversion)
   - App.tsx handleRun skips units wrapper for string aliases
   - No changes to backend files (worker.py, protocol.py, batch_manager.py)
</verification>

<success_criteria>
1. InputModal renders type toggle and shows appropriate tabs per type
2. String values flow from InputModal -> App.tsx -> batch API as actual strings
3. Backend worker.py receives string values and routes to set_string_input (existing behavior)
4. Numeric input behavior is completely unchanged (no regression)
5. TypeScript and build pass clean
</success_criteria>

<output>
After completion, create `.planning/phases/03.3-string-inputs/03.3-01-SUMMARY.md`
</output>
