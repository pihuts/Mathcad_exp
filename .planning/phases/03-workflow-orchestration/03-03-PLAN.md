---
phase: 03-workflow-orchestration
plan: 03
type: execute
wave: 1
depends_on: [03-01, 03-02]
files_modified:
  - src/server/routes.py
  - src/server/schemas.py
autonomous: true

must_haves:
  truths:
    - POST /workflows creates workflow from config
    - POST /workflows/{id}/start executes workflow
    - GET /workflows/{id} returns workflow status
    - POST /workflows/{id}/stop stops running workflow
  artifacts:
    - path: src/server/routes.py
      provides: Workflow API endpoints
      contains:
        - POST /workflows
        - POST /workflows/{id}/start
        - GET /workflows/{id}
        - POST /workflows/{id}/stop
    - path: src/server/schemas.py
      provides: API request/response schemas
      contains:
        - WorkflowRequest
        - WorkflowStatusResponse
  key_links:
    - from: workflow routes
      to: WorkflowManager
      via: get_engine_manager dependency
      pattern: manager\.workflow_manager
---

<objective>
Add API endpoints for workflow creation, execution, and monitoring.

Purpose: REST API enables frontend to manage workflows - create configurations, start execution, poll status, and stop running workflows.

Output: 4 new endpoints in routes.py (create, start, status, stop)
</object>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/03-workflow-orchestration/03-02-SUMMARY.md
@src/server/routes.py
@src/server/schemas.py
@src/engine/protocol.py
</context>

<tasks>

<task type="auto">
  <name>Add workflow endpoints to routes.py</name>
  <files>src/server/routes.py</files>
  <action>
    Add workflow endpoints to src/server/routes.py after batch endpoints:

    ```python
    # Workflow Endpoints

    @router.post("/workflows")
    async def create_workflow(req: dict, manager: EngineManager = Depends(get_engine_manager)):
        """Create and start a workflow from configuration"""
        if not manager.is_running():
            raise HTTPException(status_code=503, detail="Engine is not running")

        try:
            # Parse workflow config from request
            from engine.protocol import WorkflowConfig
            config = WorkflowConfig(**req)

            # Generate workflow ID
            workflow_id = f"workflow-{int(time.time())}"

            # Submit workflow
            manager.workflow_manager.submit_workflow(workflow_id, config)

            return {"workflow_id": workflow_id, "status": "submitted"}
        except Exception as e:
            raise HTTPException(status_code=400, detail=str(e))

    @router.post("/workflows/{workflow_id}/start")
    async def start_workflow(workflow_id: str, manager: EngineManager = Depends(get_engine_manager)):
        """Start a workflow (alias for create - workflows auto-start on submit)"""
        status = manager.workflow_manager.get_status(workflow_id)
        if not status:
            raise HTTPException(status_code=404, detail=f"Workflow {workflow_id} not found")

        return {"workflow_id": workflow_id, "status": status["status"]}

    @router.get("/workflows/{workflow_id}")
    async def get_workflow_status(workflow_id: str, manager: EngineManager = Depends(get_engine_manager)):
        """Get current workflow status"""
        status = manager.workflow_manager.get_status(workflow_id)
        if not status:
            raise HTTPException(status_code=404, detail=f"Workflow {workflow_id} not found")

        return status

    @router.post("/workflows/{workflow_id}/stop")
    async def stop_workflow(workflow_id: str, manager: EngineManager = Depends(get_engine_manager)):
        """Stop a running workflow"""
        manager.workflow_manager.stop_workflow(workflow_id)
        return {"workflow_id": workflow_id, "status": "stopped"}
    ```

    Note: Add import at top if needed: `import time`
  </action>
  <verify>
    Verify:
    - POST /workflows endpoint exists and returns workflow_id
    - GET /workflows/{id} endpoint exists and returns status
    - POST /workflows/{id}/stop endpoint exists
    - All endpoints use manager.workflow_manager
  </verify>
  <done>
    Workflow API endpoints added to routes.py
  </done>
</task>

</tasks>

<verification>
Test API structure is valid and follows existing batch endpoint patterns.
</verification>

<success_criteria>
- All 4 endpoints compile without errors
- Endpoints follow FastAPI patterns from batch routes
- Error handling is consistent (503 for engine not running, 404 for not found)
</success_criteria>

<output>
After completion, create `.planning/phases/03-workflow-orchestration/03-03-SUMMARY.md`
</output>
