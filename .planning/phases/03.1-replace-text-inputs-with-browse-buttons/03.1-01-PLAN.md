---
phase: 03.1-replace-text-inputs-with-browse-buttons
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/server/routes.py
autonomous: true

must_haves:
  truths:
    - "POST /api/v1/files/browse triggers native Windows file dialog"
    - "Dialog filters to .mcdx files by default"
    - "Endpoint returns full absolute path when file selected"
    - "Endpoint returns cancelled=true when user cancels dialog"
    - "Server remains responsive during dialog (no blocking)"
  artifacts:
    - path: "src/server/routes.py"
      provides: "File browse endpoint"
      contains: "@router.post(\"/files/browse\")"
  key_links:
    - from: "src/server/routes.py"
      to: "tkinter.filedialog"
      via: "asyncio.to_thread"
      pattern: "asyncio\\.to_thread.*_open_file_dialog"
---

<objective>
Add backend API endpoint for native Windows file dialog

Purpose: Provide reliable full file path access via tkinter native dialog, bypassing browser security restrictions that prevent access to real paths.

Output: POST /api/v1/files/browse endpoint that triggers Windows file picker and returns selected path.
</objective>

<execution_context>
@C:\Users\peter\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\peter\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.1-replace-text-inputs-with-browse-buttons/03.1-RESEARCH.md

@src/server/routes.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add file browse endpoint to routes.py</name>
  <files>src/server/routes.py</files>
  <action>
Add a new endpoint POST /files/browse that opens a native Windows file dialog:

1. Add import at top: `import asyncio` (if not present)

2. Add helper function before endpoints:
```python
def _open_file_dialog():
    """Open native file dialog - runs in separate thread"""
    from tkinter import Tk, filedialog
    root = Tk()
    root.withdraw()
    root.attributes('-topmost', True)
    root.focus_force()

    file_path = filedialog.askopenfilename(
        title="Select Mathcad Prime file",
        filetypes=[
            ("Mathcad Prime", "*.mcdx"),
            ("All files", "*.*")
        ]
    )

    root.destroy()
    return file_path
```

3. Add endpoint after existing routes:
```python
@router.post("/files/browse")
async def browse_for_file():
    """
    Open native Windows file dialog and return selected path.
    Runs tkinter in separate thread to avoid blocking FastAPI.
    """
    try:
        file_path = await asyncio.to_thread(_open_file_dialog)
        if not file_path:
            return {"file_path": None, "cancelled": True}
        return {"file_path": file_path, "cancelled": False}
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"File dialog error: {str(e)}")
```

Key points:
- Use asyncio.to_thread() to run tkinter in separate thread (FastAPI stays responsive)
- Set root.attributes('-topmost', True) so dialog appears above all windows
- Return cancelled=True when user closes dialog without selection
- Filter defaults to .mcdx but allows all files as fallback
  </action>
  <verify>
Manual test:
1. Start backend server: `cd D:\Mathcad_exp && python -m src.server.main`
2. Use curl or browser to POST http://localhost:8000/api/v1/files/browse
3. Verify native Windows file dialog appears
4. Select a .mcdx file and verify response contains full path
5. Cancel dialog and verify response has cancelled=true
  </verify>
  <done>
POST /api/v1/files/browse endpoint returns full file path from native dialog, or cancelled=true when user cancels.
  </done>
</task>

</tasks>

<verification>
1. Backend server starts without import errors
2. Endpoint appears in OpenAPI docs at /docs
3. Dialog appears on top of other windows
4. Server responds to other requests while dialog is open (non-blocking)
5. Full absolute paths returned (e.g., "D:\\path\\to\\file.mcdx")
</verification>

<success_criteria>
- Native Windows file dialog opens when endpoint called
- Full file path returned (not fakepath or just filename)
- Dialog filters to .mcdx files
- Server remains responsive during dialog display
- Clean cancellation handling
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-replace-text-inputs-with-browse-buttons/03.1-01-SUMMARY.md`
</output>
