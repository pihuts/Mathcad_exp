---
phase: 02.2-input-units-specification
plan: 02
type: execute
wave: 2
depends_on: [02.2-01]
files_modified: [src/engine/worker.py, src/engine/harness.py]
autonomous: true

must_haves:
  truths:
    - "worker.set_input() accepts optional units parameter"
    - "units parameter is passed to MathcadPy's set_real_input() with preserve_worksheet_units=True"
    - "harness.calculate_job() processes InputConfig array instead of simple dict"
  artifacts:
    - path: "src/engine/worker.py"
      provides: "Units-aware input setting method"
      contains: "def set_input(self, alias: str, value: Any, units: Optional[str] = None)"
      min_lines: 15
    - path: "src/engine/harness.py"
      provides: "Calculate job handler for InputConfig array"
      contains: "elif job.command == \"calculate_job\":"
      min_lines: 35
  key_links:
    - from: "harness.py"
      to: "worker.py"
      via: "worker.set_input(alias, value, units)"
      pattern: "worker\.set_input\([^)]+units"
    - from: "harness.py"
      to: "MathcadPy"
      via: "worksheet.set_real_input(alias, value, units, preserve_worksheet_units=True)"
      pattern: "set_real_input.*units.*preserve_worksheet_units"
---

<objective>
Update worker and harness to support units specification in batch calculations.

Purpose: Extend the worker interface to accept optional units parameter and update harness to process structured InputConfig objects instead of simple key-value dicts.
Output: Units-aware set_input() method in worker, InputConfig-array processing in harness.calculate_job().
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.2-input-units-specification/02.2-RESEARCH.md
@.planning/phases/02.2-input-units-specification/02.2-01-SUMMARY.md

@src/engine/worker.py
@src/engine/harness.py
@src/engine/protocol.py
@.venv/Lib/site-packages/MathcadPy/_application.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update worker.set_input() to accept optional units parameter</name>
  <files>src/engine/worker.py</files>
  <action>
Modify the set_input() method signature at line 58 to accept optional units parameter:

```python
def set_input(self, alias: str, value: Any, units: Optional[str] = None):
```

Update the method body (lines 59-74) to pass units to MathcadPy:

```python
    if not self.worksheet:
        raise Exception("No worksheet open")
    try:
        if isinstance(value, str):
            error = self.worksheet.set_string_input(alias, value)
            if error != 0:
                raise Exception(f"set_string_input returned error code {error}")
        else:
            # Pass units to MathcadPy's set_real_input
            # Default to "" if not specified, preserving worksheet units
            units_param = units if units is not None else ""
            error = self.worksheet.set_real_input(
                alias, float(value), units=units_param, preserve_worksheet_units=True
            )
            if error != 0:
                raise Exception(f"set_real_input returned error code {error}")
    except Exception as e:
        raise Exception(f"Failed to set input {alias}: {str(e)}")
```

Key changes:
- Add units: Optional[str] = None to signature
- Convert None to "" for MathcadPy (empty string uses worksheet units)
- Preserve preserve_worksheet_units=True for safety (prevents accidental unit changes)

Why this approach: MathcadPy's set_real_input() requires units as string. Empty string "" auto-detects worksheet units. Passing None directly would cause TypeError.
</action>
  <verify>
Verify that:
1. Worker compiles without errors: `python -c "from engine.worker import MathcadWorker; w = MathcadWorker(); print('set_input signature:', w.set_input.__annotations__)"`
2. Signature shows units parameter with correct type hint
3. Python can import worker module successfully
</verify>
  <done>worker.set_input() method accepts optional units parameter and correctly delegates to MathcadPy's set_real_input()</done>
</task>

<task type="auto">
  <name>Task 2: Update harness.calculate_job to process InputConfig array</name>
  <files>src/engine/harness.py</files>
  <action>
Update the calculate_job command handler (lines 107-141) to process InputConfig array instead of simple dict:

1. Import InputConfig at top (after line 15):
```python
from engine.protocol import JobRequest, JobResult, InputConfig
```

2. Replace the calculate_job handler (lines 107-141) with:

```python
                elif job.command == "calculate_job":
                    path = job.payload.get("path")
                    inputs_config = job.payload.get("inputs", [])  # Array of InputConfig objects

                    if path:
                        worker.open_file(path)

                    # Set inputs with units
                    for input_config in inputs_config:
                        # Support both old dict format and new InputConfig objects
                        if isinstance(input_config, dict):
                            alias = input_config.get("alias")
                            value = input_config.get("value")
                            units = input_config.get("units")
                        else:
                            # InputConfig object
                            alias = input_config.alias
                            value = input_config.value
                            units = input_config.units

                        if alias and value is not None:
                            worker.set_input(alias, value, units)

                    # Recalculate worksheet
                    worker.synchronize()

                    # Fetch all outputs
                    meta_outputs = worker.get_outputs()
                    output_data = {}

                    for out_meta in meta_outputs:
                        alias = out_meta["alias"]
                        try:
                            val = worker.get_output_value(alias)
                            output_data[alias] = val
                        except Exception as e:
                            output_data[alias] = f"Error: {str(e)}"

                    result = JobResult(
                        job_id=job.id,
                        status="success",
                        data={"outputs": output_data}
                    )
```

Key changes:
- Import InputConfig from protocol
- Change job.payload.get("inputs", {}) to job.payload.get("inputs", [])
- Loop through InputConfig objects and extract alias, value, units
- Support both old dict format (backward compatibility) and new InputConfig objects
- Pass units to worker.set_input()

Why backward compatibility: Allows gradual migration. Frontend might still send old dict format initially. Both formats work until frontend is updated.
</action>
  <verify>
Verify that:
1. Harness compiles: `python -c "from engine.harness import run_harness; print('Harness imports successfully')"`
2. InputConfig import works: `python -c "from engine.protocol import InputConfig; from engine.harness import run_harness; print('All imports OK')"`
3. No syntax errors in harness.py
</verify>
  <done>harness.calculate_job() processes InputConfig array and passes units to worker.set_input()</done>
</task>

</tasks>

<verification>
After completing this plan, verify:
- worker.set_input() accepts units parameter
- harness.calculate_job() handles InputConfig array
- Both modules compile without errors
- InputConfig can be imported in harness
</verification>

<success_criteria>
1. worker.set_input() method signature includes optional units parameter
2. units parameter is correctly converted to "" for None values before passing to MathcadPy
3. harness.calculate_job() processes inputs as array of InputConfig objects
4. Backward compatibility maintained for old dict format
</success_criteria>

<output>
After completion, create `.planning/phases/02.2-input-units-specification/02.2-02-SUMMARY.md`
</output>
