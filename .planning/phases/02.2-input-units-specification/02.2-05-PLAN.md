---
phase: 02.2-input-units-specification
plan: 05
type: execute
wave: 3
depends_on: [02.2-02, 02.2-03, 02.2-04]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "User can open a Mathcad file and see input alias configuration options"
    - "User can select units from dropdown or type custom units"
    - "User can leave units blank (worksheet units default)"
    - "Batch executes with units correctly passed to MathcadPy"
    - "Calculated results reflect correct unit conversions"
  artifacts: []
  key_links:
    - from: "Frontend UI"
      to: "Backend batch_manager"
      via: "API POST /batch/start with InputConfig array"
      pattern: "POST.*batch/start"
    - from: "Backend batch_manager"
      to: "harness.calculate_job"
      via: "submit_job('calculate_job', {path, inputs: InputConfig[]})"
      pattern: "submit_job.*calculate_job"
    - from: "harness.calculate_job"
      to: "worker.set_input"
      via: "worker.set_input(alias, value, units)"
      pattern: "set_input.*units"
    - from: "worker.set_input"
      to: "MathcadPy.set_real_input"
      via: "worksheet.set_real_input(alias, value, units, preserve_worksheet_units=True)"
      pattern: "set_real_input.*units"
---

<objective>
Verify end-to-end units specification functionality through batch processing.

Purpose: Confirm that users can specify units in the UI, units are preserved through the entire batch processing pipeline, and MathcadPy correctly applies units to input values.
Output: Verified end-to-end units specification from UI to Mathcad.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.2-input-units-specification/02.2-RESEARCH.md
@.planning/phases/02.2-input-units-specification/02.2-01-SUMMARY.md
@.planning/phases/02.2-input-units-specification/02.2-02-SUMMARY.md
@.planning/phases/02.2-input-units-specification/02.2-03-SUMMARY.md
@.planning/phases/02.2-input-units-specification/02.2-04-SUMMARY.md

@src/engine/protocol.py
@src/engine/worker.py
@src/engine/harness.py
@src/engine/batch_manager.py
@frontend/src/components/InputModal.tsx
@frontend/src/services/api.ts
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete units specification feature including:
- Backend: InputConfig dataclass, units-aware worker.set_input(), InputConfig processing in harness and batch_manager
- Frontend: Units selector in InputModal with common engineering presets
- Full data flow from UI → API → batch_manager → harness → worker → MathcadPy
  </what-built>
  <how-to-verify>
Test the full units specification flow:

1. **Start the application:**
   ```bash
   # Terminal 1: Start backend
   cd backend && python -m src.main

   # Terminal 2: Start frontend
   cd frontend && npm run dev
   ```

2. **Open Mathcad file:**
   - Navigate to http://localhost:5173 (or your frontend port)
   - Load a Mathcad file with at least one input alias (e.g., a structural calculation with length parameter "L")

3. **Configure input with units:**
   - Click on an input alias to open InputModal
   - Verify units selector dropdown is visible below the Range/CSV tabs
   - Select a unit from the dropdown (e.g., "ft (feet)")
   - Set a value (e.g., range from 0 to 10, step 1)
   - Click "Save Configuration"
   - Verify the input displays the configured value AND selected unit

4. **Test different unit options:**
   - Click the same input alias again
   - Verify units selector shows previously selected unit
   - Try typing a custom unit (e.g., "yd" for yards) using the searchable dropdown
   - Verify custom unit appears in the dropdown
   - Clear the units selection (click "x" or select "Use Worksheet Units (Default)")
   - Verify unit shows as blank/default

5. **Execute batch with units:**
   - Configure at least one input with a specific unit (e.g., "L" with "ft")
   - Start batch execution
   - Monitor batch progress (progress bar should update)
   - Wait for batch to complete

6. **Verify units were applied:**
   - Check batch results
   - Verify calculated outputs are correct for the specified units
   - (Optional) Open the generated PDF files and verify values are as expected

7. **Test error handling (if Mathcad is available):**
   - Try setting a unit that doesn't match worksheet units (if preserve_worksheet_units=True causes error)
   - Verify error is caught and displayed in batch results
   - Verify batch continues with other iterations if one fails

Expected results:
- Units selector visible and functional
- Common engineering units available as presets
- Custom unit entry works via searchable dropdown
- Units default to blank (worksheet units) when not specified
- Batch executes successfully with units applied
- Calculated results reflect correct unit conversions
- Errors are caught and displayed if units mismatch
  </how-to-verify>
  <resume-signal>Type "approved" if units specification works correctly, or describe any issues encountered</resume-signal>
</task>

</tasks>

<verification>
After user approval, verify:
- Units selector UI is functional
- Units are preserved through entire batch pipeline
- MathcadPy correctly applies units to input values
- Batch results reflect correct calculations with units
- Error handling works for unit mismatches
</verification>

<success_criteria>
1. User can specify units via dropdown in InputModal
2. User can select common units, type custom units, or leave blank
3. Units are passed through UI → API → batch_manager → harness → worker → MathcadPy
4. Batch executes with units correctly applied
5. Calculated results reflect correct unit conversions
6. User confirms functionality works as expected
</success_criteria>

<output>
After completion, create `.planning/phases/02.2-input-units-specification/02.2-05-SUMMARY.md`
</output>
