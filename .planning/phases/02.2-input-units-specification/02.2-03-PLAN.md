---
phase: 02.2-input-units-specification
plan: 03
type: execute
wave: 2
depends_on: [02.2-01]
files_modified: [src/engine/batch_manager.py]
autonomous: true

must_haves:
  truths:
    - "batch_manager extracts units from row_input when building calculate_job payload"
    - "batch_manager builds InputConfig objects for each input alias"
    - "Units are preserved through the batch processing pipeline"
  artifacts:
    - path: "src/engine/batch_manager.py"
      provides: "Batch processing with units preservation"
      contains: "def _process_batch"
      min_lines: 10
  key_links:
    - from: "batch_manager.py"
      to: "harness.py"
      via: "engine.submit_job('calculate_job', {'path': path, 'inputs': input_configs})"
      pattern: "submit_job.*calculate_job"
    - from: "batch_manager.py"
      to: "protocol.py"
      via: "from engine.protocol import InputConfig"
      pattern: "from.*protocol.*import.*InputConfig"
---

<objective>
Update batch_manager to build InputConfig objects and preserve units through batch processing.

Purpose: Ensure that units specified by users are extracted from row_input and passed to harness as InputConfig objects, preventing loss of units information.
Output: batch_manager that builds structured InputConfig objects with units field.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.2-input-units-specification/02.2-RESEARCH.md
@.planning/phases/02.2-input-units-specification/02.2-01-SUMMARY.md

@src/engine/batch_manager.py
@src/engine/protocol.py
@src/engine/harness.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update batch_manager to build InputConfig objects with units</name>
  <files>src/engine/batch_manager.py</files>
  <action>
Modify the _process_batch() method to import InputConfig and build structured input configs:

1. Add InputConfig import at top (after line 6):
```python
from engine.protocol import InputConfig
```

2. Update the calculate_job payload construction in _process_batch (lines 44-50) to preserve units:

```python
                    # 1. Submit job (assuming calculate_job command)
                    # Build InputConfig objects to preserve units
                    path = row_input.get("path")

                    # Extract input configs from row_input
                    # Frontend sends: [{"alias": "L", "value": 10, "units": "ft"}, ...]
                    input_configs = []
                    for k, v in row_input.items():
                        if k == "path":
                            continue  # Skip path field
                        if isinstance(v, dict) and "alias" in v:
                            # Already structured as InputConfig object
                            input_configs.append(InputConfig(**v))
                        else:
                            # Legacy format: simple key-value (units not specified)
                            # Wrap in InputConfig with units=None
                            input_configs.append(InputConfig(alias=k, value=v, units=None))

                    job_id = self.engine.submit_job("calculate_job", {"path": path, "inputs": input_configs})
```

Key changes:
- Import InputConfig from protocol
- Build InputConfig objects from row_input items
- Support both new structured format (InputConfig) and legacy simple dict
- Units field is preserved if present, defaults to None for legacy format

Why this approach: Frontend will send row_input like `{"path": "file.mcdx", "L": {"value": 10, "units": "ft"}, "P": {"value": 5}}`. We need to extract these and build proper InputConfig objects. Legacy support ensures compatibility if frontend sends simple values.

Alternative rejected: Modify frontend to send InputConfig array directly. This would require frontend changes first. Better to support both formats in backend for gradual migration.
</action>
  <verify>
Verify that:
1. batch_manager compiles: `python -c "from engine.batch_manager import BatchManager; print('BatchManager imports successfully')"`
2. InputConfig import works: `python -c "from engine.protocol import InputConfig; from engine.batch_manager import BatchManager; print('All imports OK')"`
3. Logic handles both formats:
   - Create test: `{"path": "test.mcdx", "L": {"value": 10, "units": "ft"}, "P": 5}`
   - Should build 2 InputConfig objects, one with units="ft", one with units=None
</verify>
  <done>batch_manager builds InputConfig objects with units preserved from row_input</done>
</task>

</tasks>

<verification>
After completing this plan, verify:
- batch_manager imports InputConfig successfully
- _process_batch() builds InputConfig array for calculate_job
- Units are preserved when present in row_input
- Legacy simple dict format still works
</verification>

<success_criteria>
1. batch_manager imports InputConfig from engine.protocol
2. _process_batch() builds InputConfig objects instead of simple dict
3. Units field is preserved when present in row_input
4. Legacy format (simple key-value pairs) still works with units=None
</success_criteria>

<output>
After completion, create `.planning/phases/02.2-input-units-specification/02.2-03-SUMMARY.md`
</output>
