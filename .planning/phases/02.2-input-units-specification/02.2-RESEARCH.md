# Phase 2.2: Input Units Specification - Research

**Researched:** 2026-01-25
**Domain:** MathcadPy units system, batch parameter configuration, UI form design
**Confidence:** HIGH

## Summary

This phase adds the ability for users to specify units of measurement for each input alias when configuring batch calculations. The MathcadPy library already supports units via the `set_real_input()` method's `units` parameter, which is currently hardcoded to an empty string. The implementation will require extending the worker interface, updating the batch data flow, and adding UI controls for units selection.

**Primary recommendation:** Implement per-input-alias units specification with common engineering unit presets, preserve `preserve_worksheet_units=True` by default for safety, and extend the data structures to pass units through the batch system.

## Standard Stack

### Core
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| MathcadPy | 0.5.0 | Mathcad Prime automation | Already in use, mature library with official units support |
| Mantine | Current | React UI components | Already used in frontend (InputModal uses Modal, Select, etc.) |
| React | Current | Frontend framework | Already used in project |

### Supporting
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| TypeScript | Latest | Type safety | Already used, extends BatchRequest interfaces |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| Per-input units | Global units per batch | Per-input is more flexible - different inputs often have different units (e.g., length in ft, force in kip) |
| Mantine Select | HTML select | Mantine provides consistent styling and validation with existing UI |

**Installation:**
```bash
# No additional packages needed
# All required libraries already installed
```

## Architecture Patterns

### Recommended Data Structure Extension

```typescript
// Extended from existing BatchRequest
export interface InputConfig {
  alias: string;
  value: any;  // Single value, range array, or CSV column reference
  units?: string;  // NEW: Optional units specification
}

export interface BatchRequest {
  batch_id: string;
  inputs: InputConfig[];  // Changed from Record<string, any>[]
  output_dir: string;
}

// Alternative: Per-row units (NOT RECOMMENDED)
export interface BatchRowWithUnits {
  path?: string;
  inputs: Record<string, { value: any, units?: string }>;
}
```

### Pattern 1: Worker Method Extension
**What:** Add optional `units` parameter to `worker.set_input()`
**When to use:** Extending existing worker interface to support units
**Example:**
```python
# Source: Based on MathcadPy source code at .venv/Lib/site-packages/MathcadPy/_application.py:336
def set_input(self, alias: str, value: Any, units: Optional[str] = None):
    """
    Set input value with optional units.
    If units is None, uses worksheet's existing units (preserve_worksheet_units=True).
    If units is "", no units override (default MathcadPy behavior).
    """
    if not self.worksheet:
        raise Exception("No worksheet open")
    try:
        if isinstance(value, str):
            error = self.worksheet.set_string_input(alias, value)
            if error != 0:
                raise Exception(f"set_string_input returned error code {error}")
        else:
            # Pass units to MathcadPy's set_real_input
            # Default to "" if not specified, preserving worksheet units
            units_param = units if units is not None else ""
            error = self.worksheet.set_real_input(
                alias, float(value), units=units_param, preserve_worksheet_units=True
            )
            if error != 0:
                raise Exception(f"set_real_input returned error code {error}")
    except Exception as e:
        raise Exception(f"Failed to set input {alias}: {str(e)}")
```

### Pattern 2: Harness Command Payload Extension
**What:** Pass units through JobRequest payload for calculate_job
**When to use:** Updating harness to handle units in batch calculations
**Example:**
```python
# Source: Based on existing harness.py pattern at line 107-116
elif job.command == "calculate_job":
    path = job.payload.get("path")
    inputs_config = job.payload.get("inputs", [])  # Changed from dict to list of configs

    if path:
        worker.open_file(path)

    # Set inputs with units
    for input_config in inputs_config:  # Each entry: {alias, value, units?}
        alias = input_config.get("alias")
        value = input_config.get("value")
        units = input_config.get("units")  # Optional
        if alias and value is not None:
            worker.set_input(alias, value, units)  # Pass units to worker
```

### Pattern 3: UI Units Selection
**What:** Add units selector to InputModal using Mantine Select
**When to use:** Providing UI for users to specify units
**Example:**
```typescript
// Source: Based on existing InputModal.tsx pattern
import { Select } from '@mantine/core';

// Common engineering unit presets
const UNIT_PRESETS = [
  { value: "", label: "Use Worksheet Units (Default)" },
  { value: "in", label: "in (inches)" },
  { value: "ft", label: "ft (feet)" },
  { value: "mm", label: "mm (millimeters)" },
  { value: "m", label: "m (meters)" },
  { value: "kip", label: "kip (kilopound force)" },
  { value: "lbf", label: "lbf (pound force)" },
  { value: "N", label: "N (newton)" },
  { value: "kN", label: "kN (kilonewton)" },
  { value: "Pa", label: "Pa (pascal)" },
  { value: "MPa", label: "MPa (megapascal)" },
  { value: "psi", label: "psi (pounds per square inch)" },
  { value: "ksf", label: "ksf (kip per square foot)" },
  { value: "kip/ft", label: "kip/ft (force per length)" },
  { value: "kip-in", label: "kip-in (moment)" },
  { value: "lb-ft", label: "lb-ft (pound-foot moment)" },
  { value: "kg", label: "kg (kilogram)" },
  { value: "lb", label: "lb (pound mass)" },
];

// Inside InputModal component
const [selectedUnits, setSelectedUnits] = useState<string | null>("");

<Select
  label="Units"
  placeholder="Select units (optional)"
  data={UNIT_PRESETS}
  value={selectedUnits}
  onChange={setSelectedUnits}
  searchable
  creatable  // Allow custom units entry
/>
```

### Anti-Patterns to Avoid
- **Global units per batch:** Don't force all inputs to use the same units - engineering calculations often mix unit types (length, force, pressure)
- **Allowing units mismatch with preserve_worksheet_units=True:** This will cause AssertionError from MathcadPy - either use False or validate units match worksheet
- **Complex unit conversion:** Don't implement custom unit conversion - Mathcad handles this internally; just pass the correct unit string
- **Ignoring units in CSV mode:** When users select a CSV column for values, they should still be able to specify units

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Unit validation | Custom unit type checking | MathcadPy's built-in validation | MathcadPy validates units against worksheet when preserve_worksheet_units=True |
| Unit conversion logic | Custom conversion functions | Mathcad's internal unit system | Mathcad handles all unit conversions automatically |
| Unit presets list | Manual array | Expandable list based on common engineering units | Start with common units, allow custom entry via Mantine's `creatable` prop |

**Key insight:** MathcadPy already handles all unit-related complexity. The implementation just needs to expose the `units` parameter through the application layers. Don't reinvent unit management.

## Common Pitfalls

### Pitfall 1: Units Mismatch with preserve_worksheet_units=True
**What goes wrong:** User specifies "in" but worksheet uses "ft", causing AssertionError
**Why it happens:** MathcadPy's `set_real_input()` with `preserve_worksheet_units=True` enforces that specified units match worksheet units exactly
**How to avoid:**
- Option 1: Keep `preserve_worksheet_units=True` and validate units before setting, or show error from MathcadPy
- Option 2: Allow user to choose `preserve_worksheet_units=False` to override worksheet units
- Option 3: Default to empty string "" which auto-detects worksheet units
**Warning signs:** AssertionError raised by MathcadPy with message "preserve_worksheet_units is True. The units argument does not equate to the units present in the Worksheet"

### Pitfall 2: Passing Units in Wrong Data Structure
**What goes wrong:** Frontend sends `{L: {value: 10, units: "in"}}` but backend expects `{alias: "L", value: 10, units: "in"}`
**Why it happens:** Inconsistent data structure across frontend, API, and batch manager
**How to avoid:**
- Define TypeScript interfaces clearly for all data structures
- Ensure BatchRequest.inputs is array of InputConfig objects, not Record<string, any>
- Update backend to destructure InputConfig: `{alias, value, units}`
**Warning signs:** TypeError or KeyError when accessing units in backend

### Pitfall 3: Losing Units in Batch Processing
**What goes wrong:** Units specified in UI but not passed to harness/worker
**Why it happens:** batch_manager.py extracts inputs using `inputs_dict = {k: v for k, v in row_input.items() if k != "path"}` which would drop units if using object structure
**How to avoid:**
- Use structured InputConfig objects: `{alias: "L", value: 10, units: "in"}`
- Or update batch manager to handle units extraction properly
- Include units in JobRequest payload for calculate_job
**Warning signs:** All inputs set with units="" in worker

### Pitfall 4: UI State Management Issues
**What goes wrong:** Units selection not saved or not passed correctly from InputModal
**Why it happens:** InputModal's `onSave` callback needs to return both values and units
**How to avoid:**
- Update InputModal props to handle units: `onSave: (values: any[], units: string) => void`
- Or return structured object: `onSave: (config: {values: any[], units: string}) => void`
- Update parent component to capture and store units
**Warning signs:** Units not appearing in batch request payload

### Pitfall 5: Backend-TypeScript Type Mismatch
**What goes wrong:** TypeScript types don't match Python backend expectations
**Why it happens:** Backend expects specific keys (alias, value, units) but frontend sends different structure
**How to avoid:**
- Use consistent naming: "units" in both TypeScript and Python
- Document the exact expected payload structure
- Consider using a shared schema definition if needed
**Warning signs:** 400 Bad Request errors from API

## Code Examples

### MathcadPy set_real_input Behavior (HIGH Confidence)
```python
# Source: .venv/Lib/site-packages/MathcadPy/_application.py:336-360
def set_real_input(self, input_alias, value, units="", preserve_worksheet_units=True):
    """Set the value of a numerical input range in the worksheet"""
    assert isinstance(input_alias, str)
    assert isinstance(units, str)
    assert isinstance(preserve_worksheet_units, bool)
    if input_alias in self.inputs():
        if preserve_worksheet_units:
            previous_units = self._get_real_input_units(input_alias)
            if units:  # If units is not equal to ""
                try:
                    assert units == previous_units
                except AssertionError as exc:
                    raise AssertionError(
                        "preserve_worksheet_units is True. The units argument "
                        "does not equate to the units present in the Worksheet"
                    ) from exc
            else:  # No units specified, use worksheet units
                units = previous_units
        error = self.ws_object.SetRealValue(input_alias, value, units)
        if error > 0:
            print(f"\nWarning!\nerror setting '{input_alias}' value/units\n")
        return error
    else:
        raise ValueError(f"{input_alias} is not a designated input field")
```

### Common Engineering Unit Presets (MEDIUM Confidence)
```typescript
// Source: Based on standard engineering practice
export const UNIT_PRESETS = [
  // Empty/Default
  { value: "", label: "Use Worksheet Units (Default)" },

  // Length
  { value: "in", label: "in (inches)" },
  { value: "ft", label: "ft (feet)" },
  { value: "mm", label: "mm (millimeters)" },
  { value: "m", label: "m (meters)" },
  { value: "km", label: "km (kilometers)" },
  { value: "yd", label: "yd (yards)" },
  { value: "mile", label: "mile (miles)" },
  { value: "micron", label: "micron (micrometer)" },
  { value: "mil", label: "mil (thousandth of inch)" },

  // Force
  { value: "N", label: "N (newton)" },
  { value: "kN", label: "kN (kilonewton)" },
  { value: "lbf", label: "lbf (pound force)" },
  { value: "kip", label: "kip (kilopound force = 1000 lbf)" },
  { value: "kgf", label: "kgf (kilogram-force)" },
  { value: "dyne", label: "dyne" },

  // Mass
  { value: "kg", label: "kg (kilogram)" },
  { value: "g", label: "g (gram)" },
  { value: "lb", label: "lb (pound mass)" },
  { value: "slug", label: "slug" },
  { value: "tonne", label: "tonne (metric ton)" },
  { value: "ton", label: "ton (short ton)" },

  // Pressure/Stress
  { value: "Pa", label: "Pa (pascal)" },
  { value: "kPa", label: "kPa (kilopascal)" },
  { value: "MPa", label: "MPa (megapascal)" },
  { value: "GPa", label: "GPa (gigapascal)" },
  { value: "psi", label: "psi (pounds per square inch)" },
  { value: "ksf", label: "ksf (kip per square foot)" },
  { value: "ksf", label: "psf (pounds per square foot)" },
  { value: "bar", label: "bar" },
  { value: "atm", label: "atm (atmosphere)" },

  // Moment
  { value: "kip-in", label: "kip-in (moment)" },
  { value: "kip-ft", label: "kip-ft (moment)" },
  { value: "lb-in", label: "lb-in (moment)" },
  { value: "lb-ft", label: "lb-ft (moment)" },
  { value: "N-m", label: "N-m (moment)" },

  // Distributed Load
  { value: "kip/ft", label: "kip/ft (force per length)" },
  { value: "lbf/ft", label: "lbf/ft (force per length)" },
  { value: "N/m", label: "N/m (force per length)" },

  // Angle
  { value: "deg", label: "deg (degrees)" },
  { value: "rad", label: "rad (radians)" },

  // Temperature
  { value: "C", label: "C (Celsius)" },
  { value: "K", label: "K (Kelvin)" },
  { value: "F", label: "F (Fahrenheit)" },

  // Area
  { value: "in^2", label: "in² (square inches)" },
  { value: "ft^2", label: "ft² (square feet)" },
  { value: "m^2", label: "m² (square meters)" },
  { value: "mm^2", label: "mm² (square millimeters)" },

  // Volume
  { value: "in^3", label: "in³ (cubic inches)" },
  { value: "ft^3", label: "ft³ (cubic feet)" },
  { value: "m^3", label: "m³ (cubic meters)" },
  { value: "L", label: "L (liter)" },
  { value: "gal", label: "gal (gallon)" },

  // Energy/Work
  { value: "J", label: "J (joule)" },
  { value: "kJ", label: "kJ (kilojoule)" },
  { value: "ft-lbf", label: "ft-lbf (foot-pound)" },

  // Power
  { value: "W", label: "W (watt)" },
  { value: "kW", label: "kW (kilowatt)" },
  { value: "hp", label: "hp (horsepower)" },
];
```

### Updated Protocol Data Structures (HIGH Confidence)
```python
# Source: Extended from existing src/engine/protocol.py
from dataclasses import dataclass, field
from typing import Any, Dict, Optional, List

@dataclass
class InputConfig:
    """Configuration for a single input in a batch calculation"""
    alias: str
    value: Any
    units: Optional[str] = None  # NEW: Units specification

@dataclass
class JobRequest:
    command: str
    payload: Dict[str, Any] = field(default_factory=dict)
    id: str = field(default_factory=lambda: str(uuid.uuid4()))

# calculate_job payload structure:
{
    "path": "/path/to/worksheet.mcdx",  # Optional, if worksheet already open
    "inputs": [  # NEW: Array of InputConfig objects (not simple dict)
        InputConfig(alias="L", value=10, units="ft"),
        InputConfig(alias="P", value=5, units="kip"),
        InputConfig(alias="alpha", value=30, units="deg")
    ]
}
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Hardcoded units="" | Optional units parameter per input | Phase 2.2 | Allows user control over units |
| Simple dict inputs | Structured InputConfig objects | Phase 2.2 | Type-safe, extensible data structure |
| UI only for values | UI for values + units | Phase 2.2 | Complete input configuration in one modal |

**Deprecated/outdated:**
- None - this is new functionality being added, not replacing existing behavior

## Open Questions

1. **Should we allow preserve_worksheet_units=False?**
   - What we know: MathcadPy supports this flag to override worksheet units
   - What's unclear: Whether users want to change units from worksheet defaults
   - Recommendation: Start with preserve_worksheet_units=True (default) for safety. If users request ability to override units, add this as an advanced option later. The empty string "" already auto-detects worksheet units, which is the safest default.

2. **How to handle units validation errors?**
   - What we know: MathcadPy raises AssertionError if units don't match worksheet
   - What's unclear: Best UX for showing this error to user
   - Recommendation: Catch MathcadPy errors in worker, convert to friendly error message, return to frontend via JobResult. Show error in BatchGrid error column.

3. **Should units be stored per batch configuration or per row?**
   - What we know: Different approaches possible
   - What's unclear: User preference
   - Recommendation: Store per batch configuration (once per input alias, not per row). This makes sense because units typically don't change within a parameter study - you're varying values, not changing units. If users need per-row units, they can override with a CSV approach later.

## Sources

### Primary (HIGH confidence)
- **MathcadPy 0.5.0** - `.venv/Lib/site-packages/MathcadPy/_application.py` lines 336-360 (set_real_input implementation), lines 248-253 (_get_real_input_units)
- **MathcadPy GitHub** - `https://github.com/MattWoodhead/MathcadPy` (README and API documentation)
- **Existing codebase** - `src/engine/worker.py` (current set_input implementation), `src/engine/harness.py` (calculate_job handler), `frontend/src/components/InputModal.tsx` (current UI pattern)
- **Existing codebase** - `src/engine/batch_manager.py` (batch processing logic), `frontend/src/services/api.ts` (TypeScript interfaces)

### Secondary (MEDIUM confidence)
- **Engineering practice** - Standard engineering units based on common usage in structural, mechanical, and civil engineering (length, force, pressure, moment, distributed load units)

### Tertiary (LOW confidence)
- None - all findings verified with source code or official documentation

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - MathcadPy and Mantine already in use, verified via source code and documentation
- Architecture: HIGH - MathcadPy API verified directly from source code, UI pattern based on existing InputModal implementation
- Pitfalls: HIGH - Identified from actual MathcadPy source code and data flow analysis through existing codebase

**Research date:** 2026-01-25
**Valid until:** 30 days (MathcadPy API stable, engineering units don't change)
